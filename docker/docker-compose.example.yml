services:
  norish:
    image: norishapp/norish:latest
    container_name: norish-app
    restart: always  # Required for server restart functionality from Admin UI
    ports:
      - "3000:3000"
    # user: "1000:1000"  # Match your host user's UID:GID (run `id` to check), only needed with bind mounts
    # The example uses named volume 'norish_data' which handles permissions automatically
    volumes:
      - norish_data:/app/uploads
    environment:
      # Core settings (required)
      AUTH_URL: http://norish.example.com # The URL where Norish is reachable
      DATABASE_URL: postgres://postgres:norish@db:5432/norish
      MASTER_KEY: <32-byte-base64-key>    # Generate with: openssl rand -base64 32
      CHROME_WS_ENDPOINT: ws://chrome-headless:3000  # Puppeteer WebSocket endpoint for web scraping
      
      # Optional
      RECIPES_DISK_DIR: /app/uploads      # Defaults to /app/uploads
      # NEXT_PUBLIC_LOG_LEVEL: info       # trace, debug, info, warn, error, fatal (default: info in prod, debug in dev)
      # TRUSTED_ORIGINS:http://192.168.1.100:3000,https://norish.example.com  # Additional trusted origins, comma separated. Useful when behind a proxy or using multiple domains.

      # ─────────────────────────────────────────────────────────────────────────
      # FIRST USER SETUP
      # ─────────────────────────────────────────────────────────────────────────
      # On first startup, configure ONE auth provider below to create your admin account.
      # After first login, use Settings => Admin to configure additional providers,
      # AI settings, video parsing, and all other options.
      
      # Option 1: Password auth - basic auth with email/password
      # If not set defaults to disabled if OIDC or OAuth is configured.
      # Defaults to true if no other auth providers are configured.
      #PASSWORD_AUTH_ENABLED=false # Enable/disable password auth default: false

      # Option 2: OIDC (Authentik, Keycloak, PocketID, etc.)
      # OIDC_NAME: NoraId
      # OIDC_ISSUER: https://nora.example.com
      # OIDC_CLIENT_ID: <client-id>
      # OIDC_CLIENT_SECRET: <client-secret>
      # OIDC_WELLKNOWN: https://auth.example.com/.well-known/openid-configuration
      # Wellknown is optional: By default the wellknown URL is derived from the issuer by appending /.well-known/openid-configuration

      # Option 3: GitHub OAuth (uncomment and remove OIDC above)
      # GITHUB_CLIENT_ID: <github-client-id>
      # GITHUB_CLIENT_SECRET: <github-client-secret>

      # Option 4: Google OAuth (uncomment and remove OIDC above)
      # GOOGLE_CLIENT_ID: <google-client-id>
      # GOOGLE_CLIENT_SECRET: <google-client-secret>

      # Option 5: LDAP (Active Directory, OpenLDAP, FreeIPA, etc.)
      # When LDAP is enabled, email/password signup is disabled - users must exist in LDAP directory.
      # LDAP_URL: ldap://openldap:389
      # LDAP_BASE_DN: ou=users,dc=example,dc=org
      # LDAP_BIND_DN: cn=readonly,dc=example,dc=org  # Optional, for authenticated bind
      # LDAP_BIND_PASSWORD: readonly                  # Optional
      # LDAP_USERNAME_ATTR: uid                       # Default: uid (use sAMAccountName for Active Directory)
      # LDAP_SEARCH_FILTER: (objectclass=inetOrgPerson)  # Optional, filter to restrict which users can login
    depends_on:
      - db
      # - openldap  # Uncomment if using LDAP

  # PostgreSQL Database
  db:
    image: postgres:17-alpine
    container_name: norish-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: norish
      POSTGRES_DB: norish
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  # Headless Chrome for recipe scraping
  chrome-headless:
    image: zenika/alpine-chrome:latest
    container_name: chrome-headless
    restart: unless-stopped
    command:
      - "--no-sandbox"
      - "--disable-gpu"
      - "--disable-dev-shm-usage"
      - "--remote-debugging-address=0.0.0.0"
      - "--remote-debugging-port=3000"
      - "--headless"
    ports:
      - "3003:3000"

  # ─────────────────────────────────────────────────────────────────────────
  # LDAP Server (for development/testing only)
  # ─────────────────────────────────────────────────────────────────────────
  # Uncomment to enable OpenLDAP for testing LDAP authentication
  # Default credentials: admin / admin
  # Test user: testuser / testpassword
  #
  # openldap:
  #   image: osixia/openldap:1.5.0
  #   container_name: openldap
  #   restart: unless-stopped
  #   environment:
  #     LDAP_ORGANISATION: "Example Inc"
  #     LDAP_DOMAIN: "example.org"
  #     LDAP_ADMIN_PASSWORD: "admin"
  #     LDAP_READONLY_USER: "true"
  #     LDAP_READONLY_USER_USERNAME: "readonly"
  #     LDAP_READONLY_USER_PASSWORD: "readonly"
  #   ports:
  #     - "389:389"
  #     - "636:636"
  #   volumes:
  #     - ldap_data:/var/lib/ldap
  #     - ldap_config:/etc/ldap/slapd.d
  #
  # # phpLDAPadmin - Web UI for managing LDAP (optional)
  # phpldapadmin:
  #   image: osixia/phpldapadmin:latest
  #   container_name: phpldapadmin
  #   restart: unless-stopped
  #   environment:
  #     PHPLDAPADMIN_LDAP_HOSTS: openldap
  #     PHPLDAPADMIN_HTTPS: "false"
  #   ports:
  #     - "8080:80"
  #   depends_on:
  #     - openldap

# Use this or map the volume to a host path if you want to persist data
volumes:
  db_data:
  norish_data:
  # ldap_data:    # Uncomment if using LDAP
  # ldap_config:  # Uncomment if using LDAP
